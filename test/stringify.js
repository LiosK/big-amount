import { BigAmount } from "../lib/index.js";
const assert = chai.assert;

describe("#toFixed()", () => {
  it("should agree with `Number#toFixed()`, except -0 and rounding", () => {
    const patNegZero = /^-(0(?:\.0+)?)$/;
    const cases = [0, 1, -1, 12345678, -12345678];
    for (const e of cases) {
      const b = BigInt(e);
      for (let den = 1; den < 100_000_000_000; den *= 10) {
        const n = e / den;
        const f = new BigAmount(b, BigInt(den));
        for (let digits = 0; digits < 10; digits++) {
          let expected = n.toFixed(digits);
          const match = expected.match(patNegZero);
          if (match) {
            expected = match[1];
          }
          assert.strictEqual(f.toFixed(digits), expected);
        }
      }
    }
  });

  it("should format fractions with arbitrary denominators", () => {
    const cases = [
      Math.E,
      Math.LN2,
      Math.LN10,
      Math.LOG2E,
      Math.LOG10E,
      Math.PI,
      Math.SQRT1_2,
      Math.SQRT2,
    ];

    for (const e of cases) {
      const f = BigAmount.fromNumber(e);
      for (let digits = 0; digits < 10; digits++) {
        assert.strictEqual(f.toFixed(digits), e.toFixed(digits));
      }
    }
  });

  it("should handle `decimalSeparator` and `groupSeparator` options properly", () => {
    const f = (den, ds) =>
      new BigAmount(12345678n, den).toFixed(ds, {
        decimalSeparator: "{ds}",
        groupSeparator: "{gs}",
      });

    assert.strictEqual(f(1n, 0), "12{gs}345{gs}678");
    assert.strictEqual(f(-1n, 0), "-12{gs}345{gs}678");

    assert.strictEqual(f(1n, 9), "12{gs}345{gs}678{ds}000000000");
    assert.strictEqual(f(10n, 9), "1{gs}234{gs}567{ds}800000000");
    assert.strictEqual(f(100n, 9), "123{gs}456{ds}780000000");
    assert.strictEqual(f(1000n, 9), "12{gs}345{ds}678000000");
    assert.strictEqual(f(10000n, 9), "1{gs}234{ds}567800000");
    assert.strictEqual(f(100000n, 9), "123{ds}456780000");
    assert.strictEqual(f(1000000n, 9), "12{ds}345678000");
    assert.strictEqual(f(10000000n, 9), "1{ds}234567800");
    assert.strictEqual(f(100000000n, 9), "0{ds}123456780");
    assert.strictEqual(f(1000000000n, 9), "0{ds}012345678");
    assert.strictEqual(f(-1n, 9), "-12{gs}345{gs}678{ds}000000000");
    assert.strictEqual(f(-10n, 9), "-1{gs}234{gs}567{ds}800000000");
    assert.strictEqual(f(-100n, 9), "-123{gs}456{ds}780000000");
    assert.strictEqual(f(-1000n, 9), "-12{gs}345{ds}678000000");
    assert.strictEqual(f(-10000n, 9), "-1{gs}234{ds}567800000");
    assert.strictEqual(f(-100000n, 9), "-123{ds}456780000");
    assert.strictEqual(f(-1000000n, 9), "-12{ds}345678000");
    assert.strictEqual(f(-10000000n, 9), "-1{ds}234567800");
    assert.strictEqual(f(-100000000n, 9), "-0{ds}123456780");
    assert.strictEqual(f(-1000000000n, 9), "-0{ds}012345678");
  });

  it("should handle `roundingMode` option properly", () => {
    const input = [];
    for (let n = -50n; n <= 50n; n++) {
      input.push(n);
    }

    const expected = {
      UP: [
        /// {{{
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        // }}}
      ],
      DOWN: [
        /// {{{
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        // }}}
      ],
      CEIL: [
        /// {{{
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        // }}}
      ],
      FLOOR: [
        /// {{{
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        // }}}
      ],
      HALF_UP: [
        /// {{{
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        "5",
        "5",
        "5",
        "5",
        "5",
        // }}}
      ],
      HALF_EVEN: [
        /// {{{
        "-5",
        "-5",
        "-5",
        "-5",
        "-5",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-4",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-3",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-2",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "-1",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "0",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "1",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "2",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "3",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "4",
        "5",
        "5",
        "5",
        "5",
        "5",
        // }}}
      ],
    };

    for (let i = 0; i < input.length; i++) {
      assert.strictEqual(
        new BigAmount(input[i], 10n).toFixed(0),
        expected["HALF_EVEN"][i]
      );
    }

    for (const mode of Object.keys(expected)) {
      for (let i = 0; i < input.length; i++) {
        assert.strictEqual(
          new BigAmount(input[i], 10n).toFixed(0, { roundingMode: mode }),
          expected[mode][i]
        );
      }
    }
  });
});

// vim: fdm=marker fmr&
